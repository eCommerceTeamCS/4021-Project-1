---
title: "Project 2"
author: "Shayne Cassidy, Sarah Nelson, Sarah Winston Nathan"
date: "12-6-2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
require("knitr")
#datadir <- "/Users/shaynecassidy/Desktop/4021/Data/AirQualityUCI"
#sourcedir <-"/Users/shaynecassidy/Desktop/4021/RCode"

#sourcedir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/RCode"
#datadir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/Data/AirQualityUCI"
sourcedir <- "C:/Users/student/SYS4021/RCode"
datadir <- "C:/Users/student/SYS4021/Data/AirQualityUCI/"
opts_knit$set(root.dir = sourcedir)
library(forecast)
library(mtsdi)
library(MTS)
```

# Load data and impute missing values
```{r, warning=FALSE}
setwd(datadir)
airquality = read.csv('AirQualityUCI.csv')

# replace -200 with NA
airquality[airquality == -200] <- NA

# convert integer type to numeric
intcols = c(4,5,7,8,9,10,11,12)
for(i in 1:length(intcols)){
  airquality[,intcols[i]] <- as.numeric(airquality[,intcols[i]])
}

setwd(sourcedir)

# create new data frame with just CO and NO2
AQdata = airquality[,c(3,10)]

# impute missing air quality data
f <- ~ CO.GT. + NO2.GT.
t <- c(seq(1,dim(AQdata)[1],1))
i <- mnimput(f, AQdata, eps=1e-3, ts=TRUE, method='gam', 
             ga.control=list(formula=paste(names(AQdata)[c(1:3)],'~ns(t,2)')))

# set airquality to imputed data
AQdata <- i$filled.dataset

# aggregate to daily maxima for model building
dailyAQ <- aggregate(AQdata, by=list(as.Date(airquality[,1],"%m/%d/%Y")), FUN=max)

# remove last 7 days
dailyAQ <- dailyAQ[1:(dim(dailyAQ)[1]-7),]
```

### Part 1: Building Univariate Time Series Models
```{r}
AQ.CO <- dailyAQ$CO.GT.
#AQ.CO <- AQdata$CO.GT.
AQ.NO2 <- dailyAQ$NO2.GT.
#AQ.NO2<-AQdata$NO2.GT.

CO.ts<-ts(AQ.CO)
NO2.ts<-ts(AQ.NO2)

plot(CO.ts)
plot(NO2.ts)
```

# Part A: Seasonality 
```{r}
acf(CO.ts)
acf(NO2.ts)

pg.CO <- spec.pgram(CO.ts,spans=9,demean=T,log='no')
pg.NO2 <- spec.pgram(NO2.ts,spans=9,demean=T,log='no')
```
The spikes in both periodagrams at repeated frequencies indicates seasonality present.

```{r}
# What are the periods of the next biggest peaks?
# sort spectrum from largest to smallest and find index
sorted.spec <- sort(pg.CO$spec, decreasing=T, index.return=T)
names(sorted.spec)

# corresponding periods
sorted.omegas <- pg.NO2$freq[sorted.spec$ix]
sorted.Ts <- 1/pg.NO2$freq[sorted.spec$ix]

# look at first 20
sorted.omegas[1:20]
sorted.Ts[1:20]
# evens out around 7
period<-7 
```

# Part B: Trends

Build a new model, CO.trend which predicts CO.ts based on the time variable
```{r}
time<-c(1:(length(CO.ts)))
CO.trend<-lm(CO.ts ~ time)
NO2.trend<-lm(NO2.ts ~ time)

summary(CO.trend)
summary(NO2.trend)
```
Here we built two new models, CO.trend and No2.trend, that both model the trend components. 
For CO.trend, the p-value is 0.00097, and for NO2.trend, the p-value is <2.2e-16. Therefore, the trend 
component is significant in both models and must be considered.

# Plot CO.trend model
```{r}
{plot(time, CO.ts, type = "l")
abline(CO.trend, col = "red")}
```
As seen in the plot of the CO.trend model, we can see that there is a clear upward trend line, which 
supports the results of our statistical test. 
The adjusted R^2 for the model CO.trend is 0.02558. 

# Plot NO2.trend model
```{r}
{plot(time, NO2.ts, type = "l")
abline(NO2.trend, col = "red")}
```
As seen in the plot of the NO2.trend model, we can see that there is a clear upward trend line.
From the naked eye, the slope seems more drastic than with the trend line from CO.trend model. 
This supports the results of our statistical test. 
The adjusted R^2 for the model NO2.trend is 0.3031.

# Model diagnostics for CO.trend
```{r}
par(mfrow=c(2,2))
plot(CO.trend, labels.id = NULL)
par(mfrow=c(1,1))
```
Residuals versus fitted plot: Does not violate assumptions. The mean is around zero and there seems to be constant variance. There are a few outliers.
Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. The Q-Q plot could be improved.
Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
Residuals versus leverage: No clear influential points with regards to Cook's distance.

The diagnostic plots do not indicate any strong violations of assumptions, so it does not appear that we need to perform any type of transformation (i.e. Log transform). 

# Model diagnostics for NO2.trend
```{r}
par(mfrow=c(2,2))
plot(NO2.trend, labels.id = NULL)
par(mfrow=c(1,1))
```
Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance.
Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. As seen by the naked eye, the Q-Q plot for N02.trend is a little better than that of CO.trend.
Scale-location: Does not violate assumptions. The mean is around 0.75 and there seems to be a constant variance around this mean. While we would prefer for the mean to be closer to zero, paired with the other diagnostic plots we do not feel like this causes a violation of assumptions. There are a few outliers.
Residuals versus leverage: No clear influential points with regards to Cook's distance.

Based on these diagnostics plots, it does not appear that we need to perform any type of transformation (i.e. Log transform).

# Add seasonality component to CO.trend
Because the seasonality component was significant, we added a seasonality component to CO.trend. We decided to use a period of 7 because the peak frequency of the periodogram is about 0.14, and 1/0.14 = 7. This implies a weekly period. 
```{r}
CO.trend.seasonal <- lm(CO.ts[time] ~ time + sin(2*pi*time/7) + cos(2*pi*time/7))
summary(CO.trend.seasonal)
```
The p-value for this model is 5.027e-13.
The adjusted R^2 for the model CO.trend.seasonal is 0.1399. 

# Add seasonality component to NO2.trend
Because the seasonality component was significant, we added a seasonality component to N02.trend. We decided to use a period of 7 because the peak frequency of the periodogram is about 0.14, and 1/0.14 = 7. This implies a weekly period. 
```{r}
NO2.trend.seasonal <- lm(NO2.ts[time] ~ time + sin(2*pi*time/7) + cos(2*pi*time/7))
summary(NO2.trend.seasonal)
```
The p-value for this model is 2.2e-16. 
The adjusted R^2 for the model N02.trend.seasonal is 0.3525 

# Model diagnostics for CO.trend.seasonal
```{r}
par(mfrow=c(2,2))
plot(CO.trend.seasonal, labels.id = NULL)
par(mfrow=c(1,1))
```
Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. 
Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. 
Residuals versus leverage: No clear influential points with regards to Cook's distance. 
The spread of points above and below the mean line in the residuals versus fitted plot and scale-location plots have improved from the CO.trend model. 

# Model diagnostics for NO2.trend.seasonal
```{r}
par(mfrow=c(2,2))
plot(NO2.trend.seasonal, labels.id = NULL)
par(mfrow=c(1,1))
```
Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance.
Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. The Q-Q plot could be improved a bit. 
Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
Residuals versus leverage: No clear influential points with regards to Cook's distance. 

Both the CO.trend.seasonal model and the NO2.trend.seasonal model demonstrate good diagnostics which do not violate assumptions, so we will not do a transformation of either model. 

## Part C: Auto-Regressive and Moving Average
#Get the residuals from the CO.trend.seasonal model above and store in e.ts:
```{r}
e.ts.CO<-ts(CO.trend.seasonal$residuals)
```
#Get the residuals from the NO2.trend.seasonal model above and store in e.ts:
```{r}
e.ts.NO2<-ts(NO2.trend.seasonal$residuals)
```
#Plot the residuals for the CO.trend.seasonal model NO2.trend.seasonal
```{r}
plot(e.ts.CO, ylab = "Residuals from CO Model")
plot(e.ts.NO2, ylab = "Residuals from NO2 Model")
```
# Plot the autocorrelation (ACF) and partial autocorrelation (PACF) of the residuals of CO.trend.seasonal
```{r}
par(mfrow=c(1,2))
acf(e.ts.CO, main="ACF of Residuals\nfrom CO.trend.seasonal")
pacf(e.ts.CO,main="PACF of Residuals\nfrom CO.trend.seasonal")
par(mfrow=c(1,1))
```
The ACF plot for the residuals of the CO.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various moving average components. 
The PACF plot for the residuals of the CO.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various autoregressive components. 
Because the ACF and PACF both show sinusoidal decay, we will also test some ARMA models with both autoregressive and moving average components.
Then we will calculate AIC values to assess several model choices. 

# Do we need to consider a first order difference of our residuals?
```{r}
par(mfrow=c(1,2))
acf(diff(e.ts.CO), main="Diff ACF of Residuals\nfrom CO.trend.seasonal")
pacf(diff(e.ts.CO),main="Diff PACF of Residuals\nfrom CO.trend.seasonal")
par(mfrow=c(1,1))
```
No, we do not need to consider a first order difference the residuals of the CO.trend.seasonal model because the ACF shows sinusoidal decay that does not cut off, and the differentiated ACF does not improve this. Thus, the value of d is 0.

# Plot the autocorrelation (ACF) and partial autocorrelation (PACF) of the residuals of NO2.trend.seasonal
```{r}
par(mfrow=c(1,2))
acf(e.ts.NO2, main="ACF of Residuals\nfrom NO2.trend.seasonal")
pacf(e.ts.NO2,main="PACF of Residuals\nfrom NO2.trend.seasonal")
par(mfrow=c(1,1))
```
The ACF plot for the residuals of the NO2.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various moving average components. 
The PACF plot for the residuals of the NO2.trend.seasonal shows sinusoidal decay. However, it also cuts off at a very high lag, thus we are going to test various autoregressive components. 
Because the ACF and PACF both show sinusoidal decay, we will also test some ARMA models with both autoregressive and moving average components.
Then we will calculate AIC values to assess several model choices. 

# Do we need to consider a first order difference of our residuals?
```{r}
par(mfrow=c(1,2))
acf(diff(e.ts.NO2), main="Diff ACF of Residuals\nfrom NO2.trend.seasonal")
pacf(diff(e.ts.NO2),main="Diff PACF of Residuals\nfrom NO2.trend.seasonal")
par(mfrow=c(1,1))
```
Both plots show sinusoidal decay, which points to using an ARMA model. 

No, we do not need to consider a first order difference the residuals of the NO2.trend.seasonal model because the ACF shows sinusoidal decay that does not cut off, and the differentiated ACF does not improve this. Thus, the value of d is 0.

# Modeling e.ts.CO 

Now we will try out some models for e.ts.CO using various p and q values

ar(1) p=1
```{r}
CO.ar1 <- arima(e.ts.CO, order=c(1,0,0), include.mean=FALSE)
summary(CO.ar1)
```
AIC = 1423.98

ar(2) p=2
```{r}
CO.ar2 <- arima(e.ts.CO, order=c(2,0,0), include.mean=FALSE)
summary(CO.ar2)
```
AIC = 1421.05

ar(3) p=3
```{r}
CO.ar3 <- arima(e.ts.CO, order=c(3,0,0), include.mean=FALSE)
summary(CO.ar3)
```
AIC = 1416.17

ma(1) p=0, q=1
```{r}
CO.ma1 <- arima(e.ts.CO, order=c(0,0,1), include.mean=FALSE)
summary(CO.ma1)
```
AIC = 1449.39

ma(2) p=0, q=2
```{r}
CO.ma2 <- arima(e.ts.CO, order=c(0,0,2), include.mean=FALSE)
summary(CO.ma2)
```
AIC = 1438.97

ma(3) p=0, q=3
```{r}
CO.ma3 <- arima(e.ts.CO, order=c(0,0,3), include.mean=FALSE)
summary(CO.ma3)
```
AIC = 1426.24

arma(1,3) p=1, q=3
```{r}
CO.arma13 <- arima(e.ts.CO, order=c(1,0,3), include.mean=FALSE)
summary(CO.arma13)
```
AIC = 1418.89

arma(1,2) p=1, q=2
```{r}
CO.arma12 <- arima(e.ts.CO, order=c(1,0,2), include.mean=FALSE)
summary(CO.arma12)
```
AIC = 1417.89

arma(2,3) p=2, q=3
```{r}
CO.arma23 <- arima(e.ts.CO, order=c(2,0,3), include.mean=FALSE)
summary(CO.arma23)
```
AIC = 1419.15

Based on the above AIC values, we would choose model AR(3) because it has the lowest AIC value. 
As a final step, we will use the auto.arima function on e.ts.CO. 
```{r}
CO.auto <- auto.arima(e.ts.CO,approximation=FALSE)
summary(CO.auto)
```
The auto arima function supports the use of AR(3) as our model, with an AIC of 1416.27. 
We will move forward using AR(3) to model the residuals of our CO.trend.seasonal model.

# Modeling e.ts.NO2 

Now we will try out some models for e.ts.CO using various p and q values. 

ar(1) p=1
```{r}
e.ts.NO2

NO2.ar1 <- arima(e.ts.NO2, order=c(1,0,0), include.mean=FALSE)
summary(NO2.ar1)
```
AIC = 3766.75

ar(2) p=2
```{r}
NO2.ar2 <- arima(e.ts.NO2, order=c(2,0,0), include.mean=FALSE)
summary(NO2.ar2)
```
AIC = 3757.73

ar(3) p=3
```{r}
NO2.ar3 <- arima(e.ts.NO2, order=c(3,0,0), include.mean=FALSE)
summary(NO2.ar3)
```
AIC = 3746.67

ma(1) p=0, q=1
```{r}
NO2.ma1 <- arima(e.ts.NO2, order=c(0,0,1), include.mean=FALSE)
summary(NO2.ma1)
```
AIC = 3826.81

ma(2) p=0, q=2
```{r}
NO2.ma2 <- arima(e.ts.NO2, order=c(0,0,2), include.mean=FALSE)
summary(NO2.ma2)
```
AIC = 3805.23

ma(3) p=0, q=3
```{r}
NO2.ma3 <- arima(e.ts.NO2, order=c(0,0,3), include.mean=FALSE)
summary(NO2.ma3)
```
AIC = 3775.63

arma(1,2) p=1, q=2
```{r}
NO2.arma12 <- arima(e.ts.NO2, order=c(1,0,2), include.mean=FALSE)
summary(NO2.arma12)
```
AIC = 3747.93

arma(1,3) p=1, q=3
```{r}
NO2.arma13 <- arima(e.ts.NO2, order=c(1,0,3), include.mean=FALSE)
summary(NO2.arma13)
```
AIC = 3749.47

arma(2,3) p=2, q=3
```{r}
NO2.arma23 <- arima(e.ts.NO2, order=c(2,0,3), include.mean=FALSE)
summary(NO2.arma23)
```
AIC = 3751.75

Based on the above AIC values, we would choose model AR(3) because it has the lowest AIC value. 
As a final step, we will use the auto.arima function on e.ts.NO2. 
```{r}
NO2.auto <- auto.arima(e.ts.NO2,approximation=FALSE)
summary(NO2.auto)
```
AIC = 3746.13
Because of the observations from the PACF and its low AIC, we will move forward using AR(3) for the residuals for our NO2.trend.seasonal model.

# Part D: Assessment of Models -- update these
We used AIC and diagnostics to assess the models for CO. 
```{r}
AIC(CO.ar1) 
AIC(CO.ar2)
AIC(CO.ar3)
AIC(CO.ma1)
AIC(CO.ma2)
AIC(CO.ma3) 
AIC(CO.arma12)
AIC(CO.arma13)
AIC(CO.arma23)
AIC(CO.auto)
```
The lowest AIC is the CO.ar3, which is what the auto.arima function produced as well. 
Therefore the model we would choose is AR(3). 

We also used AIC and diagnostics to assess the models for N02. 
```{r}
AIC(NO2.ar1)
AIC(NO2.ar2) 
AIC(NO2.ar3)
AIC(NO2.ma1)
AIC(NO2.ma2)
AIC(NO2.ma3) 
AIC(NO2.arma12) 
AIC(NO2.arma13)
AIC(NO2.arma23)
AIC(NO2.auto)
```
The lowest AIC is the NO2.ar(3), therefore we will use this model. 

Now we will consider diagnostics of the best CO model and second best CO model according to their AIC.
```{r}
tsdiag(CO.arma13, lag = 30)
```
The standardized residuals graph shows that there is noise in the ARMA(1,3) model of the residuals.
The ACF of residuals shows no significant lags in the ARMA(1,3) model.
Finally, the Ljung-Box statistic shows that at lag 10, the pvalue is very, very close to 0. While it is still adequate for lags 1-9, we could do better.

```{r}
tsdiag(CO.ar3, lag = 30)
```
The standardized residuals graph shows that there is noise in the AR(3) model of the residuals.
The ACF of residuals shows no significant lags in the AR(3) model.
Finally, the Ljung-Box statistic shows that the p-values do not touch 0, and is at adequate at all the lags.
All of these attributes from the diagnotics plots indicate a valid model.

Now we will consider diagnostics of the best NO2 model and second best NO2 model according to their AIC.
```{r}
tsdiag(NO2.arma23, lag = 30)
```
The standardized residuals graph shows that there is noise in the ARMA(2,3) model of the residuals.
The ACF of residuals shows no significant lags in the ARMA(2,3) model.
Finally, the Ljung-Box statistic shows that the p-values do not touch 0, and is at adequate at all the lags.
All of these attributes from the diagnotics plots indicate a valid model. Now, let's look at the model with the best AIC, AR(3).
```{r}
tsdiag(NO2.ar3, lag = 30)
```
The standardized residuals graph shows that there is noise in the AR(3) model of the residuals.
The ACF of residuals shows no significant lags in the AR(3) model.
Finally, the Ljung-Box statistic shows that the p-values do not touch 0, and is at adequate at all the lags.
All of these attributes from the diagnotics plots indicate a valid model. Because this model also had the lowest AIC, we will use it moving forward.

# Part E: Diagnostics
Regarding the diagnostics of the models we have chosen, there does not appear to be any concern that would warrant a transformation, such as a log transform. The diagnostics also do not demonstrate that our models violate assumptions, so we can conclude that they are valid models to use. 

### Part 2: Building Multivariate Time Series Models

## Part A: Seasonality
We used the same models as we used in Part 1 because we found that these were valid models that did not violate assumptions. The models in Part 1 demonstrated seasonality, which we were able to observe from the periodograms that the models produced. These periodograms showed peaks at a frequency around 0.14. This would make the period 1/0.14, or about 7. This makes intuitive sense because this would be a weekly period. Thus, we added a seasonality component to the models to account for the seasonality of the models. So, since we will be using the same models from part 1, we do not need to execute this process again. 

## Part B: Trends
Again, since we are using the same models as we used in Part 1, we can conclude that the data for both CO and NO2 show trends, so we will need to account for trend when building our model. In part 1 we demonstrated this by building linear models to model the trend component. The models showed significant p-values indicating a trend in the data. So, our models accounted for trend. Since we are using the same models, this analysis still applies here for the multivariate time series model. 

## Part C: Auto-Regressive and Moving Average
```{r}
allResiduals <- data.frame(e.ts.CO, e.ts.NO2)
colnames(allResiduals) <- c("CO","NO2")
cor(allResiduals)
```
Correlation between residuals of NO2 and CO is 0.58914.

# Build VARMA model to CO and NO2 residuals
```{r, include=FALSE}
AICmatrix <- matrix(NA, 3, 4)
for(p in 1:3){
  for(q in 0:3){
    varma.model <- VARMACpp(allResiduals, p=p, q=q, include.mean=F)
    AICmatrix[p,q+1] <- varma.model$aic
  }
}
```
Because our univariate models both had auto-regressive and moving average components, we can create a varma model that will evaluate different p and q values, which we can interpret to determine which model is best. 

## Part D: Assessment of Models

We will analyze the AICmatrix to find which model has the lowest AIC. 
```{r}
AICmatrix
```
According to the AICmatrix, the model with p=2 and q=2 has the lowest AIC, this we should use these values to build our model. 
The AIC for p=2 and q=2 is 7.16333. The next best model is p=3 and q=3, with an AIC of 7.1883 . 
We will build these 2 models and compare them using diagnostics.  
```{r setup2, include = FALSE}
varma.model2 <- VARMACpp(allResiduals, p=3, q=3, include.mean=F)
varma.model2
MTSdiag(varma.model2)
```
The CCF plots shows the correlations are all within the dashed line, meaning that the correlations are not statistically different from 0.
The significance plot of CCM shows a few lags that are below the dashed line. While this is not too problematic, we can do better.
The plot of p-values for Ljung-Box statistics shows that the model is adequate until around lag 12.
The residual plot for CO and NO2 show noise, *yay!* 

```{r}
varma.model <- VARMACpp(allResiduals, p=2, q=2, include.mean=F)
varma.model
MTSdiag(varma.model)
```
The CCF plots shows the correlations are all within the dashed line, meaning that the correlations are not statistically different from 0.
The significance plot of CCM shows a few lags that are below the dashed line. While this is not too problematic, we can do better.
The plot of p-values for Ljung-Box statistics shows that the model is adequate until around lag 11.
The residual plot for CO and NO2 show noise, *yay again!*

After investigating the AIC values and the diagnostic plots of the two comparable VARMA models, we have decided to use VARMA(2,2) due to its lowest AIC value and acceptable diagnostic plots. 

## Part E: Diagnostics
While we considered the diagnostics to be acceptable, they could be better. For the p-values for Ljung-Box statistic plot, it would be better if there were more adequate lags (i.e. p-values do not become significant until future lags). In the significance plot of CCM, there were a few points below the dashed line. However, these observations do not pose any major concerns for the remainder of our analysis.

### Part 3: Simulating from Univariate and Multivariate Time Series Models
```{r}
next.year.time <- c(1:(365))
next.year <- data.frame(time = next.year.time)

COmean <- predict(CO.trend.seasonal, newdata = next.year)
NO2mean <- predict(NO2.trend.seasonal, newdata = next.year)

set.seed(10)
T.simUCO = arima.sim(CO.ar3$model,365)
set.seed(5)
T.simUNO2 = arima.sim(n=365, list(ar=c(NO2.ar3$coef[1],NO2.ar3$coef[2],NO2.ar3$coef[3])),sd=sqrt(NO2.ar3$sigma2))

```

```{r}
T.simM = VARMAsim(365,phi=varma.model$Phi,theta=varma.model$Theta,sigma=varma.model$Sigma)
```

## Part A: Ability to reproduce appearance
Multivariate and Univariate: CO 
```{r}
{plot(COmean + T.simUCO)
lines(dailyAQ$CO.GT.[1:365] + allResiduals$CO[1:365],col="blue")
lines(COmean + T.simM$series[,1], col = "red")}
```
Above is a plot of the original CO observations, our univariate simulation of CO, and our multivariate simulation of CO. The plots seem to demonstrate similar behavior, indicating that we were able to reproduce appearance of time series. The one main difference in the graphs is that the magnitudes of the simulated models are slightly greater than the magnitudes of the original observations. 

Multivariate and Univariate: NO2
``` {r}
{plot(NO2mean + T.simUNO2)
lines(dailyAQ$NO2.GT.[1:365] + allResiduals$NO2[1:365],col="blue")
lines(NO2mean + T.simM$series[,2], col = "red")}
```
Above is a plot of the original NO2 observations, our univariate simulation of NO2, and our multivariate simulation of NO2. The plots seem to demonstrate similar behavior, however, some areas of the simulated points have slightly different appearance to the original time series (dips in the graph don't completely line up). However, for the most part they do look quite similar, indicating that our simulated models did appropriately reproduce the appearance of time series.

## Part B: Ability to reproduce observed trends

Univariate: CO
```{r}
COsim<-COmean+T.simUCO
CO.trend.seasonal.sim <- lm(COsim[next.year.time] ~ next.year.time + sin(2*pi*next.year.time/7) + cos(2*pi*next.year.time/7))
summary(CO.trend.seasonal)
summary(CO.trend.seasonal.sim)
```
The coefficient estimates for time and the seasonality components are very similar to each other for each respective model. This means means that using our simulated data, we were able to reproduce the observed trends of each time series.

Univariate: NO2
```{r}
NO2sim<-NO2mean+T.simUNO2
NO2.trend.seasonal.sim <- lm(NO2sim[next.year.time] ~ next.year.time + sin(2*pi*next.year.time/7) + cos(2*pi*next.year.time/7))
summary(NO2.trend.seasonal)
summary(NO2.trend.seasonal.sim)
```
The coefficient estimates for time and the seasonality components are very similar to each other for each respective model. This means means that using our simulated data, we were able to reproduce the observed trends of each time series.

Multivariate: CO
```{r}
MCOsim<-COmean+T.simM$series[,1]
MCO.trend.seasonal.sim <- lm(MCOsim[next.year.time] ~ next.year.time + sin(2*pi*next.year.time/7) + cos(2*pi*next.year.time/7))
summary(CO.trend.seasonal)
summary(MCO.trend.seasonal.sim)
```
The coefficient estimates for time and the seasonality components are fairly similar to each other for each respective model. The seasonality coefficients are slightly different, but still close to each other. This means that using our simulated data, we were able to reproduce the observed trends of each time series.

Multivariate: NO2
```{r}
MNO2sim<-NO2mean+T.simM$series[,2]
MNO2.trend.seasonal.sim <- lm(MNO2sim[next.year.time] ~ next.year.time + sin(2*pi*next.year.time/7) + cos(2*pi*next.year.time/7))
summary(NO2.trend.seasonal)
summary(MNO2.trend.seasonal.sim)
```
The coefficient estimates for time and the seasonality components are fairly similar to each other for each respective model. The intercept (107.88 vs 114.92) and seasonality coefficients are slightly different, but still close to each other. This means that using our simulated data, we were able to reproduce the observed trends of each time series fairly well.

## Part C: Ability to reproduce seasonality

Univariate: CO
```{r}
par(mfrow=c(2,1))
pg.CO <- spec.pgram(CO.ts,spans=9,demean=T,log='no')
pg.COsim <- spec.pgram(COsim,spans=9,demean=T,log='no')
par(mfrow=c(1,1))

```
The periodograms show spikes at the same locations and follow the same general trend, indicating that our univariate model was able to reproduce seasonality of the original time series.

Univariate: NO2
```{r}
par(mfrow=c(2,1))
pg.NO2 <- spec.pgram(NO2.ts,spans=9,demean=T,log='no')
pg.NO2sim <- spec.pgram(NO2sim,spans=9,demean=T,log='no')
par(mfrow=c(1,1))
```
Again, the periodogram of our simulated model has spikes at the same locations as the original time series periodogram, indicating that the univariate model for NO2 was able to reproduce seasonality of the original time series. 

Multivariate: CO
```{r}
par(mfrow=c(2,1))
pg.CO <- spec.pgram(CO.ts,spans=9,demean=T,log='no')
pg.MCOsim <- spec.pgram(MCOsim,spans=9,demean=T,log='no')
par(mfrow=c(1,1))
```
The periodograms look similar and show peaks at the same locations indicating that the simulated multivariate CO model effectively reproduced seasonality. 

Multivariate: NO2
```{r}
par(mfrow=c(2,1))
pg.NO2 <- spec.pgram(NO2.ts,spans=9,demean=T,log='no')
pg.MNO2sim <- spec.pgram(MNO2sim,spans=9,demean=T,log='no')
par(mfrow=c(1,1))
```
The periodograms look similar and show peaks at the same locations indicating that the simulated multivariate NO2 model effectively reproduced seasonality. 

All of the above simulated periodograms for univariate and multivariate models all show a peak frequency at around 0.14, similar to the observed periodograms. This means we were able to accurately reproduce seasonality of each time series.

## Part D: Ability to reproduce observed mean and variance

Univariate: CO
```{r}
mean(dailyAQ$CO.GT.)
mean(COsim)
var(dailyAQ$CO.GT.)
var(COsim)
```
The means are very close to each other (4.365 vs. 4.278), which indicates our model reproduces the observed mean well. However, the variances are slightly different (3.623 vs 1.4479). This coincides with the fact that our simulated values were all slightly lower than each of the observed value.

Univariate: NO2
```{r}
mean(dailyAQ$NO2.GT.)
mean(NO2sim)
var(dailyAQ$NO2.GT.)
var(NO2sim)
```
The means are very close to each other (164.5335 vs. 161.6154), which indicates our model reproduces the observed mean well. The variances are also very close (2657.72 vs 2644.952) indicating that our model also reproduces observed variance well. 

Multivariate: CO
```{r}
mean(dailyAQ$CO.GT.)
mean(MCOsim)
var(dailyAQ$CO.GT.)
var(MCOsim)
```
The means are very close to each other (4.365 vs. 4.3988), which indicates our multivariate model reproduces the observed mean for CO well. The variances are also similar (3.623 vs 2.847), indicating that our multivariate model also reproduces the observed variance CO well.

Multivariate: NO2
```{r}
mean(dailyAQ$NO2.GT.)
mean(MNO2sim)
var(dailyAQ$NO2.GT.)
var(MNO2sim)
```
The means are very close to each other (164.5335 vs. 160.9884), which indicates our multivariate model reproduces the observed mean for NO2 well. The variances are also fairly similar (2657.722 vs 2056.203), indicating that our multivariate model also reproduces the observed variance for NO2 well.

## Part E: Ability to reproduce auto-correlation

Univariate: CO
```{r}
par(mfrow=c(1,2))
acf(CO.ts)
acf(COsim)
par(mfrow=c(1,1))
par(mfrow=c(1,2))
pacf(CO.ts)
pacf(COsim)
par(mfrow=c(1,1))
```

Univariate: NO2
```{r}
par(mfrow=c(1,2))
acf(NO2.ts)
acf(NO2sim)
par(mfrow=c(1,1))
par(mfrow=c(1,2))
pacf(NO2.ts)
pacf(NO2sim)
par(mfrow=c(1,1))
```

Multivariate: CO
```{r}
par(mfrow=c(1,2))
acf(CO.ts)
acf(MCOsim)
par(mfrow=c(1,1))

par(mfrow=c(1,2))
pacf(CO.ts)
pacf(MCOsim)
par(mfrow=c(1,1))
```


Multivariate: NO2
```{r}
par(mfrow=c(1,2))
acf(NO2.ts)
acf(MNO2sim)
par(mfrow=c(1,1))
par(mfrow=c(1,2))
pacf(NO2.ts)
pacf(MNO2sim)
par(mfrow=c(1,1))
```
Despite small differences, the ACF and PACF of each model follows similar trends to those of the original observations. Thus, the models appropriately reproduced the auto-correlation of each time series. 

## Part F: Ability to reproduce observed cross-correlation
```{r}
cor(dailyAQ$CO.GT.,dailyAQ$NO2.GT.) #observed
cor(COsim,NO2sim) #simulated from univariate
cor(MCOsim,MNO2sim) #simulated from multivariate
```
The correlation between CO and NO2 in the original data is 0.608. However, the correlation between CO and NO2 in our simulated univariate model is 0.382. So, we would have liked for our univariate models to reproduce observed cross-correlation more accurately. On the other hand, the multivariate simulated model produced a correlation value of 0.718, indicating that the CO and NO2 variables were more correlated than in the original data. However, this difference is much less than the univariate simulation, so we can conclude that the multivariate models were able to more accurately reproduce observed cross-correlations across time series. 


### Bonus

```{r}
CO.forecast <- forecast(CO.ar3, h=7)
NO2.forecast <- forecast(NO2.ar3, h=7)
MCO.forecast <- forecast(varma.model$data[,1],h=7)
MNO2.forecast <- forecast(varma.model$data[,2], h=7)
```
# Prediction performance
# Create test set from temp data set with last 6 months

# The test period in months
```{r}
next.7day.time <- c((length(dailyAQ)-7):(length(dailyAQ)))
```

# The test data frame
```{r}
next.7day.CO <- data.frame(time.temp = 378:384, CO = CO.ts[378:384])
next.7day.NO2 <- data.frame(time.temp = 378:384, NO2 = NO2.ts[378:384])
```

# The actual time series for the test period
```{r}
next.7day.CO.ts <- ts(next.7day.CO$CO)
next.7day.NO2.ts <- ts(next.7day.NO2$NO2)
```

# Prediction for the next 6 months:
```{r}
E_Y.pred.CO <- predict(CO.trend.seasonal, newdata=next.7day.CO)
e_t.pred.CO <- forecast(CO.ar3, h=7)
next.7day.prediction.CO <- E_Y.pred.CO[378:384] + e_t.pred.CO$mean

e_t.pred.MCO <- forecast(varma.model$data[,1], h=7)
next.7day.prediction.MCO <- E_Y.pred.CO[378:384] + e_t.pred.MCO$mean

E_Y.pred.NO2 <- predict(NO2.trend.seasonal, newdata=next.7day.NO2)
e_t.pred.NO2 <- forecast(NO2.ar3, h=7)
next.7day.prediction.NO2 <- E_Y.pred.NO2[378:384] + e_t.pred.NO2$mean

e_t.pred.MNO2 <- forecast(varma.model$data[,1], h=7)
next.7day.prediction.MNO2 <- E_Y.pred.NO2[378:384] + e_t.pred.MNO2$mean
```

# MSE:
```{r}
mean((next.7day.prediction.CO-next.7day.CO$CO)^2)
mean((next.7day.prediction.NO2-next.7day.NO2$NO2)^2)
mean((next.7day.prediction.MCO-next.7day.CO$CO)^2)
mean((next.7day.prediction.MNO2-next.7day.NO2$NO2)^2)
```

# Plot actual values and predicted values
```{r}
par(mfrow=c(1,2))
# CO forecasts
{plot(ts(next.7day.CO$CO),type='o',ylim=c(0,10))
lines(ts(next.7day.prediction.CO),col='red',type='o')
lines(1:7, E_Y.pred.CO[378:384] + e_t.pred.CO$lower[,2], col = "red", lty = "dashed")
lines(1:7, E_Y.pred.CO[378:384] + e_t.pred.CO$upper[,2], col = "red", lty = "dashed")
lines(ts(next.7day.prediction.MCO),col='green',type='o')
lines(1:7, E_Y.pred.CO[378:384] + e_t.pred.MCO$lower[,2], col = "green", lty = "dashed")
lines(1:7, E_Y.pred.CO[378:384] + e_t.pred.MCO$upper[,2], col = "green", lty = "dashed")
legend(5,9, legend = c("Actual", "Predicted (univariate)", "Predicted(multivariate)"), lwd = 3, col = c("black", "red", "green"))}

#NO2 forecasts
{plot(ts(next.7day.NO2$NO2),type='o',ylim=c(0,250))
lines(ts(next.7day.prediction.NO2),col='red',type='o')
lines(1:7, E_Y.pred.NO2[378:384] + e_t.pred.NO2$lower[,2], col = "red", lty = "dashed")
lines(1:7, E_Y.pred.NO2[378:384] + e_t.pred.NO2$upper[,2], col = "red", lty = "dashed")
lines(ts(next.7day.prediction.MNO2),col='green',type='o')
lines(1:7, E_Y.pred.NO2[378:384] + e_t.pred.MNO2$lower[,2], col = "green", lty = "dashed")
lines(1:7, E_Y.pred.NO2[378:384] + e_t.pred.MNO2$upper[,2], col = "green", lty = "dashed")
legend(1,75, legend = c("Actual", "Predicted(univariate)", "Predicted(multivariate)"), lwd = 2, col = c("black", "red", "green"))
par(mfrow=c(1,1))}
```