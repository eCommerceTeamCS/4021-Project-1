---
title: "Project 2"
author: "Shayne Cassidy, Sarah Nelson, Sarah Winston Nathan"
date: "12-6-2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
require("knitr")
#datadir <- "/Users/shaynecassidy/Desktop/4021/Data/AirQualityUCI"
#sourcedir <-"/Users/shaynecassidy/Desktop/4021/RCode"

# sourcedir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/RCode"
# datadir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/Data/AirQualityUCI"
sourcedir <- "C:/Users/student/SYS4021/RCode"
datadir <- "C:/Users/student/SYS4021/Data/AirQualityUCI/"
opts_knit$set(root.dir = sourcedir)
library(forecast)
library(mtsdi)
library(MTS)
```

# Load data and impute missing values
```{r, warning=FALSE}
setwd(datadir)
airquality = read.csv('AirQualityUCI.csv')

# replace -200 with NA
airquality[airquality == -200] <- NA

# convert integer type to numeric
intcols = c(4,5,7,8,9,10,11,12)
for(i in 1:length(intcols)){
  airquality[,intcols[i]] <- as.numeric(airquality[,intcols[i]])
}

setwd(sourcedir)

# create new data frame with just CO and NO2
AQdata = airquality[,c(3,10)]

# impute missing air quality data
f <- ~ CO.GT. + NO2.GT.
t <- c(seq(1,dim(AQdata)[1],1))
i <- mnimput(f, AQdata, eps=1e-3, ts=TRUE, method='gam', 
             ga.control=list(formula=paste(names(AQdata)[c(1:3)],'~ns(t,2)')))

# set airquality to imputed data
AQdata <- i$filled.dataset

# aggregate to daily maxima for model building
dailyAQ <- aggregate(AQdata, by=list(as.Date(airquality[,1],"%m/%d/%Y")), FUN=max)

# remove last 7 days
dailyAQ <- dailyAQ[1:(dim(dailyAQ)[1]-7),]
```


### Part 1: Building Univariate Time Series Models
```{r}
AQ.CO <- dailyAQ$CO.GT.
#AQ.CO <- AQdata$CO.GT.
AQ.NO2 <- dailyAQ$NO2.GT.
#AQ.NO2<-AQdata$NO2.GT.

CO.ts<-ts(AQ.CO)
NO2.ts<-ts(AQ.NO2)

plot(CO.ts)
plot(NO2.ts)
```

# Part A: Seasonality 
```{r}
acf(CO.ts)
acf(NO2.ts)
# both show sinusoidal exponential decay --> AR model

pg.CO <- spec.pgram(CO.ts,spans=9,demean=T,log='no')
# spikes in periodagram at repeated frequencies --> indicates seasonality present
max.pg.CO<-pg.CO$freq[which(pg.CO$spec==max(pg.CO$spec))]

# Where is the peak? -->0.002604167
max.pg.CO

# What is the period? -->384
1/max.pg.CO
```
```{r}
pg.NO2 <- spec.pgram(NO2.ts,spans=9,demean=T,log='no')
# spikes in periodagram at repeated frequencies --> indicates seasonality present
max.pg.NO2<-pg.CO$freq[which(pg.NO2$spec==max(pg.NO2$spec))]

# Where is the peak? -->0.00520833
max.pg.NO2

# What is the period? -->192
1/max.pg.NO2

# What are the periods of the next biggest peaks?
# sort spectrum from largest to smallest and find index
sorted.spec <- sort(pg.CO$spec, decreasing=T, index.return=T)
names(sorted.spec)

# corresponding periods
sorted.omegas <- pg.NO2$freq[sorted.spec$ix]
sorted.Ts <- 1/pg.NO2$freq[sorted.spec$ix]

# look at first 20
sorted.omegas[1:20]
sorted.Ts[1:192]
# evens around 7
period<-7 
```

# Part B: Trends
```{r}
# Build a new model, CO.trend which predicts CO.ts based on the time variable
time<-c(1:(length(CO.ts)))
CO.trend<-lm(CO.ts ~ time)
NO2.trend<-lm(NO2.ts ~ time)

summary(CO.trend)
summary(NO2.trend)

# Here we built two new models, CO.trend and No2.trend, that both model the trend components. 
# For CO.trend, the p-value is 0.00097, and for NO2.trend, the p-value is <2.2e-16. Therefore, the trend 
# component is significant in both models and must be considered.
```
# Plot CO.trend model
```{r}
{plot(time, CO.ts, type = "l")
abline(CO.trend, col = "red")}
# As seen in the plot of the CO.trend model, we can see that there is a clear upward trend line, which 
# supports the results of our statistical test. 
# The adjusted R^2 for the model CO.trend is 0.02558. 
```

# Plot NO2.trend model
```{r}
{plot(time, NO2.ts, type = "l")
abline(NO2.trend, col = "red")}
# As seen in the plot of the NO2.trend model, we can see that there is a clear upward trend line.
# From the naked eye, the slope seems more drastic than with the trend line from CO.trend model. 
# This supports the results of our statistical test. 
# The adjusted R^2 for the model NO2.trend is 0.3031. 
```
# Model diagnostics for CO.trend
```{r}
par(mfrow=c(2,2))
plot(CO.trend, labels.id = NULL)
par(mfrow=c(1,1))
# Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
# Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. The Q-Q plot could be improved.
# Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
# Residuals versus leverage: No clear influential points with regards to Cook's distance. 
```
# Model diagnostics for NO2.trend
```{r}
par(mfrow=c(2,2))
plot(NO2.trend, labels.id = NULL)
par(mfrow=c(1,1))
# Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance.
# Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. As seen by the naked eye, the Q-Q plot for N02.trend is a little better than that of CO.trend.
# Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
# Residuals versus leverage: No clear influential points with regards to Cook's distance. 
```
# Add seasonality component to CO.trend
```{r}
# Because the seasonality component was significant, we added a seasonality component to CO.trend. We decided to use a period of 365 because our intuition says there should be an annual cycle. 
CO.trend.seasonal <- lm(CO.ts[time] ~ time + sin(2*pi*time/7) + cos(2*pi*time/7))
summary(CO.trend.seasonal)
# The p-value for this model is 2.449e-10.
# The adjusted R^2 for the model CO.trend.seasonal is 0.1109. 
```
# add seasonality component to NO2.trend
```{r}
# Because the seasonality component was significant, we added a seasonality component to N02.trend. We decided to use a period of 365 because our intuition says there should be an annual cycle.
NO2.trend.seasonal <- lm(NO2.ts[time] ~ time + sin(2*pi*time/7) + cos(2*pi*time/7))
summary(NO2.trend.seasonal)
# The p-value for this model is 2.2e-16. 
# The adjusted R^2 for the model N02.trend.seasonal is 0.388 
```
# Model diagnostics for CO.trend.seasonal
```{r}
par(mfrow=c(2,2))
plot(CO.trend.seasonal, labels.id = NULL)
par(mfrow=c(1,1))
# Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance. 
# Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. 
# Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. 
# Residuals versus leverage: No clear influential points with regards to Cook's distance. 
# The spread of points above and below the mean line in the residuals versus fitted plot and scale-location plots have improved from the CO.trend model. 
```
# Model diagnostics for NO2.trend.seasonal
```{r}
par(mfrow=c(2,2))
plot(NO2.trend.seasonal, labels.id = NULL)
par(mfrow=c(1,1))
# Residuals versus fitted plot: Does not violate assumptions. The mean is about zero and there seems to be constant variance.
# Q-Q plot: The fit to the line is fairly solid, thus no drastic violation of assumptions. The Q-Q plot could be improved a bit. 
# Scale-location: Does not violate assumptions. The mean is about zero and there seems to be constant variance. There are a few outliers.
# Residuals versus leverage: No clear influential points with regards to Cook's distance. 
```

## Part C: Auto-Regressive and Moving Average
#Get the residuals from the CO.trend.seasonal model above and store in e.ts:
```{r}
e.ts.CO<-ts(CO.trend.seasonal$residuals)
```
#Get the residuals from the NO2.trend.seasonal model above and store in e.ts:
```{r}
e.ts.NO2<-ts(NO2.trend.seasonal$residuals)
```
#Plot the residuals for the CO.trend.seasonal model NO2.trend.seasonal
```{r}
plot(e.ts.CO, ylab = "Residuals from CO Model")
plot(e.ts.NO2, ylab = "Residuals from NO2 Model")
```
# Plot the autocorrelation (ACF) and partial autocorrelation (PACF) of the residuals of CO.trend.seasonal
```{r}
par(mfrow=c(1,2))
acf(e.ts.CO, main="ACF of Residuals\nfrom CO.trend.seasonal")
pacf(e.ts.CO,main="PACF of Residuals\nfrom CO.trend.seasonal")
par(mfrow=c(1,1))
```
The ACF plot for the residuals of the CO.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various moving average components. 
The PACF plot for the residuals of the CO.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various autoregressive components. 
Because the ACF and PACF both show sinusoidal decay, we will also test some ARMA models with both autoregressive and moving average components.
Then we will calculate AIC values to assess several model choices. 

# Do we need to consider a first order difference of our residuals?
```{r}
par(mfrow=c(1,2))
acf(diff(e.ts.CO), main="Diff ACF of Residuals\nfrom CO.trend.seasonal")
pacf(diff(e.ts.CO),main="Diff PACF of Residuals\nfrom CO.trend.seasonal")
par(mfrow=c(1,1))
```
No, we do not need to consider a first order difference the residuals of the CO.trend.seasonal model because the ACF shows sinusoidal decay that does not cut off, and the differentiated ACF does not improve this. Thus, the value of d is 0.

# Plot the autocorrelation (ACF) and partial autocorrelation (PACF) of the residuals of NO2.trend.seasonal
```{r}
par(mfrow=c(1,2))
acf(e.ts.NO2, main="ACF of Residuals\nfrom NO2.trend.seasonal")
pacf(e.ts.NO2,main="PACF of Residuals\nfrom NO2.trend.seasonal")
par(mfrow=c(1,1))
```
The ACF plot for the residuals of the NO2.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various moving average components. 
The PACF plot for the residuals of the NO2.trend.seasonal shows sinusoidal decay. However, it cuts off at a very high lag, thus we are going to test various autoregressive components. 
Because the ACF and PACF both show sinusoidal decay, we will also test some ARMA models with both autoregressive and moving average components.
Then we will calculate AIC values to assess several model choices. 

# Do we need to consider a first order difference of our residuals?
```{r}
par(mfrow=c(1,2))
acf(diff(e.ts.NO2), main="Diff ACF of Residuals\nfrom NO2.trend.seasonal")
pacf(diff(e.ts.NO2),main="Diff PACF of Residuals\nfrom NO2.trend.seasonal")
par(mfrow=c(1,1))
```
Both plots show sinusoidal decay, which points to using an ARMA model. 
Yes, we should consider a first order difference of our residuals for NO2 because the ACF of the original has positive autocorrelations out to a high number of lags. By taking the first order difference of the residuals, we reduce this number of lags. Thus, the value of d is 1, to represent first order differentation.

# Modeling e.ts.CO 

Now we will try out some models for e.ts.CO using various p and q values

ar(1) p=1
```{r}
CO.ar1 <- arima(e.ts.CO, order=c(1,0,0), include.mean=FALSE)
summary(CO.ar1)
```
AIC = 1423.98

ar(2) p=2
```{r}
CO.ar2 <- arima(e.ts.CO, order=c(2,0,0), include.mean=FALSE)
summary(CO.ar2)
```
AIC = 1421.05

ar(3) p=3
```{r}
CO.ar3 <- arima(e.ts.CO, order=c(3,0,0), include.mean=FALSE)
summary(CO.ar3)
```
AIC = 1416.17

ma(1) p=0, q=1
```{r}
CO.ma1 <- arima(e.ts.CO, order=c(0,0,1), include.mean=FALSE)
summary(CO.ma1)
```
AIC = 1449.39

ma(2) p=0, q=2
```{r}
CO.ma2 <- arima(e.ts.CO, order=c(0,0,2), include.mean=FALSE)
summary(CO.ma2)
```
AIC = 1438.97

ma(3) p=0, q=3
```{r}
CO.ma3 <- arima(e.ts.CO, order=c(0,0,3), include.mean=FALSE)
summary(CO.ma3)
```
AIC = 1426.24

arma(1,3) p=1, q=3
```{r}
CO.arma13 <- arima(e.ts.CO, order=c(1,0,3), include.mean=FALSE)
summary(CO.arma13)
```
AIC = 1418.89

arma(1,2) p=1, q=2
```{r}
CO.arma12 <- arima(e.ts.CO, order=c(1,0,2), include.mean=FALSE)
summary(CO.arma12)
```
AIC = 1417.89

arma(2,3) p=2, q=3
```{r}
CO.arma23 <- arima(e.ts.CO, order=c(2,0,3), include.mean=FALSE)
summary(CO.arma23)
```
AIC = 1419.15

Based on the above AIC values, we would choose model AR(3) because it has the lowest value. 
As a final step, we will use the auto.arima function on e.ts.CO. 
```{r}
CO.auto <- auto.arima(e.ts.CO,approximation=FALSE)
summary(CO.auto)
```
The auto arima function supports the use of AR(3) as our model, with an AIC of 1416.27. 
We will move forward using AR(3) to model the residuals of our CO.trend.seasonal model.

# Modeling e.ts.NO2 

Now we will try out some models for e.ts.CO using p=2 and q=3. 

ar(1) p=1
```{r}
NO2.ar1 <- arima(e.ts.NO2, order=c(1,1,0), include.mean=FALSE)
summary(NO2.ar1)
```
AIC = 3794.26

ar(2) p=2
```{r}
NO2.ar2 <- arima(e.ts.NO2, order=c(2,1,0), include.mean=FALSE)
summary(NO2.ar2)
```
AIC = 3764.89

ar(3) p=3
```{r}
NO2.ar3 <- arima(e.ts.NO2, order=c(3,1,0), include.mean=FALSE)
summary(NO2.ar3)
```
AIC = 3764.98

ma(1) p=0, q=1
```{r}
NO2.ma1 <- arima(e.ts.NO2, order=c(0,1,1), include.mean=FALSE)
summary(NO2.ma1)
```
AIC = 3759.62

ma(2) p=0, q=2
```{r}
NO2.ma2 <- arima(e.ts.NO2, order=c(0,1,2), include.mean=FALSE)
summary(NO2.ma2)
```
AIC = 3748.95

ma(3) p=0, q=3
```{r}
NO2.ma3 <- arima(e.ts.NO2, order=c(0,1,3), include.mean=FALSE)
summary(NO2.ma3)
```
AIC = 3750.79

arma(1,2) p=1, q=2
```{r}
NO2.arma12 <- arima(e.ts.NO2, order=c(1,1,2), include.mean=FALSE)
summary(NO2.arma12)
```
AIC = 3746.02

arma(1,3) p=1, q=3
```{r}
NO2.arma13 <- arima(e.ts.NO2, order=c(1,1,3), include.mean=FALSE)
summary(NO2.arma13)
```
AIC = 3744.05

arma(2,3) p=2, q=3
```{r}
NO2.arma23 <- arima(e.ts.NO2, order=c(2,1,3), include.mean=FALSE)
summary(NO2.arma23)
```
AIC = 3744.7

Based on the above AIC values, we would choose model ARMA(1,3) because it has the lowest AIC value. 
As a final step, we will use the auto.arima function on e.ts.NO2. 
```{r}
NO2.auto <- auto.arima(e.ts.NO2,approximation=FALSE)
summary(NO2.auto)
```
AIC = 3746.02
Because it has a lower AIC (3744.05) than the model from the auto.arima function (3746.02), we will move forward using ARMA(1,3) with a first order difference of the residuals for our NO2.trend.seasonal model.

# Part D: Assessment of Models -- update these
We used AIC and diagnostics to assess the models for CO. 
```{r}
AIC(CO.ar1) 
AIC(CO.ar2)
AIC(CO.ar3)
AIC(CO.ma1)
AIC(CO.ma2)
AIC(CO.ma3) 
AIC(CO.arma12)
AIC(CO.arma13)
AIC(CO.arma23)
AIC(CO.auto)
```
The lowest AIC is the CO.ar3, which is what the auto.arima function produced as well. 
Therefore the model we would choose is AR(3). 

We also used AIC and diagnostics to assess the models for N02. 
```{r}
AIC(NO2.ar1)
AIC(NO2.ar2) 
AIC(NO2.ar3)
AIC(NO2.ma1)
AIC(NO2.ma2)
AIC(NO2.ma3) 
AIC(NO2.arma12) 
AIC(NO2.arma13)
AIC(NO2.arma23)
AIC(NO2.auto)
```
The lowest AIC is the NO2.arma(13), which is what the auto.arima function produced as well. 
Therefore the model we would choose is ARMA(1,3). 

# Part E: Diagnostics
```{r}
tsdiag(CO.ar3, lag = 30)
```
The above graph shows that ... 

```{r}
tsdiag(NO2.arma13, lag = 30)
```
The above graph shows that ... 


### Part 2: Building Multivariate Time Series Models

## Part A: Seasonality
Same as part 1a

## Part B: Trends
Same as part 1b

## Part C: Auto-Regressive and Moving Average
```{r}
allResiduals <- data.frame(e.ts.CO, e.ts.NO2)
colnames(allResiduals) <- c("CO","NO2")
cor(allResiduals)
```
Correlation between residuals of NO2 and CO is 0.58914.

# Build VARMA model to CO and NO2 residuals
```{r, include=FALSE}
AICmatrix <- matrix(NA, 3, 4)
for(p in 1:3){
  for(q in 0:3){
    varma.model <- VARMACpp(allResiduals, p=p, q=q, include.mean=F)
    AICmatrix[p,q+1] <- varma.model$aic
  }
}
```
## Part D: Assessment of Models

We will analyze the AICmatrix to find which model has the lowest AIC. 
```{r}
AICmatrix
```
According to the AICmatrix, the model with p=2 and q=3 has the lowest AIC, this we should use these values to build our model. 
The AIC for p=2 and q=3 is 7.227414. The next best model is p=2 and q=2, with an AIC of 7.249367. 
We will build these 2 models and compare them using diagnostics.  
```{r}
varma.model <- VARMACpp(allResiduals, p=2, q=3, include.mean=F)
varma.model
MTSdiag(varma.model)

varma.model2 <- VARMACpp(allResiduals, p=2, q=2, include.mean=F)
varma.model2
MTSdiag(varma.model2)
```
According to the above diagnostics ____ 

** Also in the assignment they said " Please mask the output of tested models except for those whose diagnostics you discuss using ‘include=FALSE’ as an argument in the relevant chunk. " so need to figure out what that means ??


## Part E: Diagnostics
```{r}
MTSdiag(varma.model)
```
The significance plot of CCM shows that ...
The plot of p-values for Ljung-Box statistics shows that ...
The residual plot for CO shows that ...
The residual plot for NO2 shows that ... 


### Part 3: Simulating from Univariate and Multivariate Time Series Models
```{r}
next.year.time <- c(1:(365))
next.year <- data.frame(time = next.year.time)

COmean <- predict(CO.trend.seasonal, newdata = next.year)
NO2mean <- predict(NO2.trend.seasonal, newdata = next.year)

set.seed(14)
T.simUCO = arima.sim(CO.ar3$model,365)
T.simUNO2 = arima.sim(NO2.arma13$model,365)
```
```{r}
{plot(COmean + T.simUCO)
lines(dailyAQ$CO.GT.[1:365] + allResiduals$CO[1:365],col="blue")}
```
Above is a plot of ? which shows ___

``` {r}
{plot(T.simUNO2)
lines(e.ts.NO2[1:365],col="green")}
```
Above is a plot of ? which shows ___

```{r}
T.sim = VARMAsim(365,phi=varma.model$Phi,theta=varma.model$Theta,sigma=varma.model$Sigma)
```
## Part A: Ability to reproduce appearance
# Compare correlation of simulated residuals to actual residuals
```{r}
cor(T.sim$series)
cor(allResiduals)
```
Interpret these results .. 

# Plot observations and simulations


## Part B: Ability to reproduce observed trends
```{r}

```

## Part C: Ability to reproduce seasonality
```{r}

```

## Part D: Ability to reproduce observed mean and variance
```{r}

```

## Part E: Ability to reproduce auto-correlation
```{r}

```

## Part F: Ability to reproduce observed cross-correlation
```{r}

```
