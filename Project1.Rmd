---
title: "Project 1"
author: "Shayne Cassidy (sc5za) Sarah Winston Nathan (swn2bf) Sarah Nelson (skn5mq)"
date: "10/23/2019"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
require("knitr")
traindir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/Data/TrainData"
sourcedir <-"C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/RCode"
#traindir <- "/Users/shaynecassidy/Desktop/4021/Data/TrainData"
#sourcedir <-"/Users/shaynecassidy/Desktop/4021/RCode"
#traindir <- "/Users/student/SYS4021/Data/Trains"
#sourcedir <- "/Users/student/SYS4021/RCode"
opts_knit$set(root.dir = sourcedir)
opts_chunk$set(warning=FALSE)
```

Load data and combine data from 2001-2018 into totacts.
```{r}
# Source AccidentInput
#setwd("/Users/shaynecassidy/Desktop/4021/RCode")
source("AccidentInput.R")

# list of data frames for each year of accident data
acts <- file.inputl(traindir)

# data frame with all accidents from all years from 2001 - 2018

# Get a common set the variables
comvar <- intersect(colnames(acts[[1]]), colnames(acts[[8]]))

# the combined data frame
totacts <- combine.data(acts, comvar)
```


Create a new variable, Casualty, where Casualty = TOTINJ + TOTKLD
```{r}
totacts$Casualty <- totacts$TOTKLD + totacts$TOTINJ
```

Build a data frame with only extreme accidents for ACCDMG
```{r}
dmgbox <- boxplot(totacts$ACCDMG)
xdmg <- totacts[totacts$ACCDMG > dmgbox$stats[5],]
# Remove duplicates from xdmg and call new data frame xdmgnd
xdmgnd <- xdmg[!(duplicated(xdmg[, c("INCDTNO", "YEAR", "MONTH", "DAY", "TIMEHR",
                                     "TIMEMIN")])),]
```

Build a data frame with only extreme accidents for Casualty
```{r}
casbox <- boxplot(totacts$Casualty)
cas <- totacts[totacts$Casualty > casbox$stats[5],]
# Remove duplicates from cdmg and call new data frame casnd
casnd <- cas[!(duplicated(cas[, c("INCDTNO", "YEAR", "MONTH", "DAY", "TIMEHR",
                                     "TIMEMIN")])),]
```

Treatment of categorical variables

These variables will need to be tested in our hypotheses. So, in order to appropriately test the hypotheses relating to these categorical variables, these categorical variables are recoded into two levels each. 
```{r}
# Create a freight train variable
Freight <- rep(0, nrow(xdmgnd))
Freight[which(xdmgnd$TYPEQ == 1)] <- 1
Freight <- as.factor(Freight)

# Create a human factors variable
HF <- rep(0, nrow(xdmgnd))
HF[which(substr(xdmgnd$CAUSE, 1, 1) == "H")] <- 1
HF <- as.factor(HF)
```

```{r}
# Create a derailment variable
Derail <- rep(0, nrow(casnd))
Derail[which(casnd$TYPE == 1)] <- 1 
Derail <- as.factor(Derail)

# Create a highway-rail crossing variable
HRX <- rep(0,nrow(casnd))
HRX[which(casnd$TYPE == 7)] <- 1
HRX <- as.factor(HRX)
```


## Part 1: Generating Hypotheses
ACCDMG: We used the following visualizations, summary statistics, and external supporting evidence to arrive at our hypotheses for ACCDMG. 
```{r}
# Freight, Human Factors
library(lattice)
mean(xdmgnd$ACCDMG)
max(xdmgnd$ACCDMG)
```

```{r}
xdmgnd$TYPEQ <- as.numeric(xdmgnd$TYPEQ)
xdmgnd$TYPEQ <- factor(xdmgnd$TYPEQ, labels = c("Freight", "Passenger", "Commuter",
                                                "Work",  "Single", "CutofCars",
                                                "Yard", "Light", "Maint"))
barplot(table(xdmgnd$TYPEQ))
```
Freight trains have the highest number of accidents with extreme damage compared to the other types. Thus, we will further investigate freight trains by including this variable as a part of our hypotheses. 


```{r}
bwplot(as.factor(TYPEQ)~ACCDMG, data = xdmgnd, main = "Box Plots of Accident
       Damage", xlab = "Damage ($)", ylab = "Type Train")
```
Although passenger trains have the accidents with the highest amount of accident damage, freight trains have a higher frequency of accidents with substantial accident damage.

```{r}
xdmgnd$Cause <- rep(NA, nrow(xdmgnd))
xdmgnd$Cause[which(substr(xdmgnd$CAUSE, 1, 1) == "M")] <- "M" 
xdmgnd$Cause[which(substr(xdmgnd$CAUSE, 1, 1) == "T")] <- "T"
xdmgnd$Cause[which(substr(xdmgnd$CAUSE, 1, 1) == "S")] <- "S"
xdmgnd$Cause[which(substr(xdmgnd$CAUSE, 1, 1) == "H")] <- "H"
xdmgnd$Cause[which(substr(xdmgnd$CAUSE, 1, 1) == "E")] <- "E"
xdmgnd$Cause <- factor(xdmgnd$Cause) 
barplot(table(xdmgnd$Cause))
```
Although Cause T (Rack, Roadbed and Structures) has the largest number of accidents with extreme accident damage, we thought that investigating Human Factors (the second largest number of accidents with extreme damage) would be a more actionable hypotheses. 

```{r}
bwplot(as.factor(Cause)~ACCDMG, data = xdmgnd, main = "Box Plots of Accident
       Damage", xlab = "Damage ($)", ylab = "Cause")

```
Additionally, the most costly accidents in this data set are accidents caused by human factors, thus human factors is an important factor to evaluate with our hypotheses. 

Casualties: We used the following visualizations, summary statistics, and external supporting evidence to arrive at our hypotheses for Casualties.
```{r}
# Derailment, Highway-Rail Crossing
casnd$TYPE <- factor(casnd$TYPE, labels = c("Derailment", "HeadOn", "Rearend",
                                            "Side", "Raking", "BrokenTrain",
                                            "Hwy-Rail", "GradeX", "Obstruction",
                                            "Explosive",
                                            "Fire","Other","SeeNarrative" ))
barplot(table(casnd$TYPE))
mean(casnd$Casualty)
max(casnd$Casualty)
```
As seen in the above histogram, Highway-Rail accidents and Derailments have the most number of accidents that result in casualties, so these are important factors to consider when developing hypotheses about casualties. 


Based on the above analysis, we have been able to form some well-informed hypotheses from the visualizations. They are as follows, listed as null and alternative hypotheses and followed by how we arrived at them:

..As for accident severity in regards to **Accident Damage (ACCDMG)**:
*1) H0: Accidents involving freight trains do not significantly increase accident damage.*
*Ha: Accidents involving freight trains do significantly increase accident damage.*

*This is an actionable hypothesis because more regulations can be put in place to promote safe driving with freight trains in dangerous areas.*

*2) H0: Accidents caused by Human Factors do not significantly increase accident damage.*
*Ha Accidents caused by Human Factors do significantly increase accident damage.*

*This is an actionable hypothesis because better recurrent training programs can be implemented to improve conductor and engineer abilities to safely manage tasks when in control of a train.*

..As for accident severity in regards to **Casualties**: 

*1) H0: Derailment caused accidents do not significantly increase the number of casualties.*  
*Ha: Derailment caused accidents do significantly increase the number of casualties.* 

*This is an actionable hypothesis because train wheels and tracks can be manufactured in order to prevent derailments.*

*2) H0: Highway-rail crossing accidents do not significantly increase number of casualties.*
*Ha: Highway-rail crossing accidents are do significantly increase the number of casualties.*

*This is actionable because if the null hypothesis is accepted, then trains can be required to follow more safety precautions when traveling near highways, and other traffic laws can be put in place to encourage safe driving around highway-railroad crossings. *


## Part 2: ACCDMG Analysis

*Hypotheses 1 and 2*

*1) H0: Accidents involving freight trains do not significantly increase accident damage.*
*Ha: Accidents involving freight trains do significantly increase accident damage.*

*2) H0: Accidents caused by Human Factors do not significantly increase accident damage.*
*Ha Accidents caused by Human Factors do significantly increase accident damage.*

```{r}
source("SPM_Panel.R")
uva.pairs(xdmgnd[,c("ACCDMG", "TRNSPD", "CARS", "TONS", "HEADEND1", "CDTRHR",
                    "ENGRS")])
```
Based on the visualizations and correlation values from the scatter plot matices above, we have decided to include TRNSPD, CARS, TONS, and HEADEND1 as quantitative variables in our model.

To test our hypotheses, we will include the two treated categorical variables, Freight and HF (Human Factors), with the selected quantitative variables in our linear model.
```{r}
xdmgnd.lm1 <- lm(ACCDMG ~ Freight + HF + CARS + TRNSPD + HEADEND1 + TONS,
                 data=xdmgnd)
summary(xdmgnd.lm1)
```

#Plot diagnostic graphs individually
```{r}
plot(xdmgnd.lm1,which=1) #Residual vs. Fitted
```
This plot violates the assumptions for the residual vs fitted diagnostic plot because there is not a mean of zero and there is not a constant variance. 

```{r}
plot(xdmgnd.lm1,which=2) #QQ
```
This graph shows a violation of assumptions because the points clearly do not follow the line. This represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(xdmgnd.lm1,which=3) #Scale-Location
```
This graph shows a violation of assumptions because the points do not have a mean of zero and there is not a constant variance. 

```{r}
plot(xdmgnd.lm1,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(xdmgnd.lm1,which=5) #Redisuals vs. Leverage
```
These graphs shows a violation of assumptions because there are incidents with very large Cook's distances.

The analysis above shows that this model does not meet the assumptions required for assessment of this linear model. So, we can conclude that this is not a good model for assessing casualties from train accidents. Therefore, we next perform a log transormation of this model to assess if this creates a more effective model of casualties. 

```{r}
xdmgnd.lm2 <- lm(log(ACCDMG) ~ Freight + HF + CARS + TRNSPD + HEADEND1 + TONS,
                 data=xdmgnd)
summary(xdmgnd.lm2)
```

#Plot diagnostic graphs individually
```{r}
plot(xdmgnd.lm2,which=1) #Residual vs. Fitted
```
This graph shows significant improvement from the non-transformed model (xdmgnd.lm1), as there is more constant variance and the mean is closer to 0.

```{r}
plot(xdmgnd.lm2,which=2) #QQ
```
This graph shows significant improvement from the non-transformed model (xdmgnd.lm1), as the points are more linear. However, there is still some deviation from the line which represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(xdmgnd.lm2,which=3) #Scale-Location
```
Although the points still do not have a mean of zero after the transformation, there is more constant variance.


```{r}
plot(xdmgnd.lm2,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(xdmgnd.lm2,which=5) #Redisuals vs. Leverage
```
Clearly, the log transform helped reduce the impact of influential point as the Cook's distances are smaller than in the previous model. 

Based on the diagnostic plots, we feel confident with this transformed model and will run a stepwise regression to determine if we can further improve it.
```{r}
xdmgnd.lm2.step<-step(xdmgnd.lm2, trace=T)
summary(xdmgnd.lm2.step)
```
```{r}
anova(xdmgnd.lm2,xdmgnd.lm2.step)
```
The stepwise function removed the Freight variable from our model, indicating that this may not be as important of a factor as we thought when forming our hypothesis. Since the p-value from the partial F-test is greater than 0.05, we fail to reject the null hypothesis and choose the smaller model due to Okham's Razor. 

```{r}
summary(xdmgnd.lm1)$adj.r.squared
summary(xdmgnd.lm2)$adj.r.squared
summary(xdmgnd.lm2.step)$adj.r.squared
#AIC
AIC(xdmgnd.lm1)
AIC(xdmgnd.lm2)
AIC(xdmgnd.lm2.step)
#BIC
AIC(xdmgnd.lm1,k=log(nrow(xdmgnd)))
AIC(xdmgnd.lm2,k=log(nrow(xdmgnd)))
AIC(xdmgnd.lm2.step,k=log(nrow(casnd)))
```
The adjusted R2 value for the first model is 0.07191597 and for the transformed model it is 0.1757921, which is clearly a significant improvement. The stepwise regression, which removed the freight variable has an R2 value of 0.1758473, which is a slight improvement from the original transformed model. Additionally, which each new model, the AIC and BIC decreased, particularly after doing the log transformation.

The p-values for both Freight (0.00104, **0.4565**, NA) and HF (1.4e-11, 0.0248, **0.0289**) increased when we performed the transformation. However, Human Factors remains significant in each model, while Freight does not. Thus, we can reject the null hypothesis that Human Factors does not significantly increase accident damage and we fail to reject the null hypothesis that Freight does not significantly increase accident damage. 

## Part 3: Casualties

*Hypotheses 1 and 2*

*1) H0: Derailment caused accidents do not significantly increase the number of casualties.*  
*Ha: Derailment caused accidents do significantly increase the number of casualties.* 

*2) H0: Highway-rail crossing accidents do not significantly increase number of casualties.*
*Ha: Highway-rail crossing accidents are do significantly increase the number of casualties.*

```{r}
source("SPM_Panel.R")
uva.pairs(casnd[,c("Casualty", "CARS", "TIMEHR", "TEMP", "TRKDNSTY", "TRNSPD",
                   "TONS")])
```
Due to the low correlations between casualty and TIMEHR, TONS, and TRKDNSTY, we will not include these variables in our model. 

To test our hypotheses, we will include the two treated categorical variables, Derail and HRX (Highway-Rail Crossing), with the selected quantitative variables in our linear model.
```{r}
casnd.lm1 <- lm(Casualty ~ Derail + HRX + TEMP + CARS + TRNSPD, data=casnd)
summary(casnd.lm1)
```


#Plot diagnostic graphs individually
```{r}
plot(casnd.lm1,which=1) #Residual vs. Fitted
```
This plot violates the assumptions for the residual vs fitted diagnostic plot because there is not a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm1,which=2) #QQ
```
This graph shows a violation of assumptions because the points clearly do not follow the line. This represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(casnd.lm1,which=3) #Scale-Location
```
This graph shows a violation of assumptions because the points do not have a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm1,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(casnd.lm1,which=5) #Redisuals vs. Leverage
```
These graphs shows a violation of assumptions because there are incidents with very large Cook's distances.

The analysis above shows that this model does not meet the assumptions required for assessment of this linear model. So, we can conclude that this is not a good model for assessing casualties from train accidents. Therefore, we next perform a log transormation of this model to assess if this creates a more effective model of casualties. 

```{r}
casnd.lm2 <- lm(log(Casualty) ~ Derail + HRX + TEMP + CARS + TRNSPD, data=casnd)
summary(casnd.lm2)
```

#Plot diagnostic graphs individually
```{r}
plot(casnd.lm2,which=1) #Residual vs. Fitted
```
This plot violates the assumptions for the residual vs fitted diagnostic plot because there is not a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm2,which=2) #QQ
```
This graph shows a violation of assumptions because the points clearly do not follow the line. This represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(casnd.lm2,which=3) #Scale-Location
```
This graph shows a violation of assumptions because the points do not have a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm2,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(casnd.lm2,which=5) #Redisuals vs. Leverage
```
Although these graphs still show a violation of assumptions due to large Cook's distances, there is a slight improvement from the previous model after taking the log transformation. 

```{r}
summary(casnd.lm1)
summary(casnd.lm2)
#AIC
AIC(casnd.lm1)
AIC(casnd.lm2)
#BIC
AIC(casnd.lm1,k=log(nrow(casnd)))
AIC(casnd.lm2,k=log(nrow(casnd)))


```
The adjusted R2 value for the first model is 0.02212 and for the transformed model it is 0.06468. While the transformed model shows a larger adjusted R2 value and lower AIC and BIC values than the first model, none of these values indicate a strong model. This indicates that neither model is appropriate to assess both hypotheses related to casualties. Thus, in order to determine an effective model to predict casualty severity, we would like to investigate non-linear regression models. 

Although the p-values for Derail (0.002514, 0.026724) and HRX (3.73e-05, < 2e-16) technically indicate significance, the assumptions for the linear models were not met, thus we cannot draw conclusions about our hypotheses from these models. 

## Part 4: Evidence and Recommendations to FRA

### Part a)

*ACCDMG*
The p-values for both Freight (0.00104, **0.4565**, NA) and HF (1.4e-11, 0.0248, **0.0289**) increased when we performed the transformation. However, Human Factors remains significant in each model, while Freight does not. Thus, we can reject the null hypothesis that Human Factors does not significantly increase accident damage and we fail to reject the null hypothesis that Freight does not significantly increase accident damage. 


*Casualties*
Although the p-values for Derail (0.002514, 0.026724) and HRX (3.73e-05, < 2e-16) technically indicate significance, the assumptions for the linear models were not met, thus we cannot draw conclusions about our hypotheses from these models. So, in order to reject or accept these hypotheses, more models would need to be explored to perform a statistically significant assessment.


### Part b)

*ACCDMG*
We recommend to not focus on freight trains when attempting to reduce accident damage. We do recommend further investigating human factors. They do impact accident damage, so measures could be put in place to reduce accidents caused by human factor errors. According to the US Department of Transportation, the main initiatives of the Action Plan are intended to reduce accidents caused by human factors by addressing fatigue, improving highway-rail-grade crossing safety, and enhancing emergency preparedness training (Sarah).

*Casualties*
Because the diagnostic plot assumptions were not met in any of our models assessing casualties, we recommend looking into non-linear regression models to evaluate accidents with many casualties. Because many of the accidents with casualties only have a small number of casualties, it might be beneficial to look into a Poisson or Weibull models.

