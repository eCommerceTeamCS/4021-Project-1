---
title: "Project 1"
author: "Shayne Cassidy (sc5za) Sarah Winston Nathan (swn2bf) Sarah Nelson (skn5mq)"
date: "10/20/2019"
output: html_notebook
---

```{r setup, include=FALSE}
require("knitr")
traindir <- "C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/Data/TrainData"
sourcedir <-"C:/Users/swnathan/Documents/4y1s/sys4021/InClassR/RCode"
#traindir <- "/Users/shaynecassidy/Desktop/4021/Data/TrainData"
#sourcedir <-"/Users/shaynecassidy/Desktop/4021/RCode"
#traindir <- "/Users/student/SYS4021/Data/Trains"
#sourcedir <- "/Users/student/SYS4021/RCode"
opts_knit$set(root.dir = sourcedir)
opts_chunk$set(warning=FALSE)
```

Load data and combine data from 2001-2018 into totacts.
```{r}
# Source AccidentInput
#setwd("/Users/shaynecassidy/Desktop/4021/RCode")
source("AccidentInput.R")

# list of data frames for each year of accident data
acts <- file.inputl(traindir)

# data frame with all accidents from all years from 2001 - 2018

# Get a common set the variables
comvar <- intersect(colnames(acts[[1]]), colnames(acts[[8]]))

# the combined data frame
totacts <- combine.data(acts, comvar)
```


Create a new variable, Casualty, where Casualty = TOTINJ + TOTKLD
```{r}
totacts$Casualty <- totacts$TOTKLD + totacts$TOTINJ
```

Build a data frame with only extreme accidents for ACCDMG
```{r}
dmgbox <- boxplot(totacts$ACCDMG)
xdmg <- totacts[totacts$ACCDMG > dmgbox$stats[5],]
# Remove duplicates from xdmg and call new data frame xdmgnd
xdmgnd <- xdmg[!(duplicated(xdmg[, c("INCDTNO", "YEAR", "MONTH", "DAY", "TIMEHR",
                                     "TIMEMIN")])),]
```

Build a data frame with only extreme accidents for Casualty
```{r}
casbox <- boxplot(totacts$Casualty)
cas <- totacts[totacts$Casualty > casbox$stats[5],]
# Remove duplicates from cdmg and call new data frame cdmgnd
casnd <- cas[!(duplicated(cas[, c("INCDTNO", "YEAR", "MONTH", "DAY", "TIMEHR",
                                     "TIMEMIN")])),]
```

Treatment of categorical variables

These variables will need to be tested in our hypotheses. So, in order to appropriately test the hypotheses relating to these categorical variables, these categorical variables are recoded into two levels each. 
```{r}
# Create a freight train variable
Freight <- rep(0, nrow(xdmgnd))
Freight[which(xdmgnd$TYPEQ == 1)] <- 1
Freight <- as.factor(Freight)

# Create a human factors variable
HF <- rep(0, nrow(xdmgnd))
HF[which(substr(xdmgnd$CAUSE, 1, 1) == "H")] <- 1
HF <- as.factor(HF)
```

```{r}
# Create a derailment variable
Derail <- rep(0, nrow(casnd))
Derail[which(casnd$TYPE == 1)] <- 1 
Derail <- as.factor(Derail)

# Create a highway-rail crossing variable
HRX <- rep(0,nrow(casnd))
HRX[which(casnd$TYPE == 7)] <- 1
HRX <- as.factor(HRX)
```


## Part 1: Generating Hypotheses

Based on the analysis conducted in part 1b, I have been able to form some well-informed hypotheses from the visualizations. They are as follows, listed as null and alternative hypotheses and followed by how I arrived at them:

..As for accident severity in regards to **Accident Damage (ACCDMG)**:
*1) H0: Higher train speeds among freight trains have no effect on accident damage*
*Ha: Higher train speeds among freight trains result in higher accident damage*

*2) H0: Accidents caused by Human Factors have no effect on accident damage*
*Ha Accidents caused by Human Factors have an effect on accident damage*

..As for accident severity in regards to **Casualties**: 

*1) H0: Derailment caused accidents do not increase the number of casualties*  
*Ha: Derailment caused accidents do increase the number of casualties* 

*2) H0: Highway-rail crossing accidents are more severe than other types of accidents*
*Ha: Highway-rail crossing accidents are not more severe than other types of accidents*

## Part 2: ACCDMG Analysis

*Hypothesis 1*

Fill in here steps a-e
(a) The feature and model selection techniques you used to find appropriate models for this problem;
(b) Your treatment of ordinal and categorical variables (i.e., how were
they coded);
(c) How you assessed your models (e.g., adjusted R2, AIC, etc.);
(d) How you diagnosed problems with the models; and
(e) How you adjusted the models based on these assessments.


*Hypothesis 2*

Fill in here steps a-e
(a) The feature and model selection techniques you used to find appropriate models for this problem;
(b) Your treatment of ordinal and categorical variables (i.e., how were
they coded);
(c) How you assessed your models (e.g., adjusted R2, AIC, etc.);
(d) How you diagnosed problems with the models; and
(e) How you adjusted the models based on these assessments.


## Part 3: Casualties

*Hypothesis 1*

*1) H0: Derailment caused accidents do not increase the number of casualties*  
*Ha: Derailment caused accidents do increase the number of casualties* 

Fill in here steps a-e
(a) The feature and model selection techniques you used to find appropriate models for this problem;

```{r}
source("SPM_Panel.R")
uva.pairs(casnd[,c("Casualty", "CARS", "TIMEHR", "TEMP", "TRKDNSTY", "TRNSPD", "TONS")])
```
Due to the low correlations between casualty and TIMEHR, TONS, and TRKDNSTY, we will not include these variables in our model. 

```{r}
casnd.lm1 <- lm(Casualty ~ Derail + HRX + TEMP + CARS + TRNSPD, data=casnd)
summary(casnd.lm1)
```


#Plot diagnostic graphs individually
```{r}
plot(casnd.lm1,which=1) #Residual vs. Fitted
```
This plot violates the assumptions for the residual vs fitted diagnostic plot because there is not a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm1,which=2) #QQ
```
This graph shows a violation of assumptions because the points clearly do not follow the line. This represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(casnd.lm1,which=3) #Scale-Location
```
This graph shows a violation of assumptions because the points do not have a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm1,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(casnd.lm1,which=5) #Redisuals vs. Leverage
```
These graphs shows a violation of assumptions because there are incidents with very large Cook's distances.

The analysis above shows that this model does not meet the assumptions required for assessment of this linear model. So, we can conclude that this is not a good model for assessing casualties from train accidents. Therefore, we next perform a log transormation of this model to assess if this creates a more effective model of casualties. 

```{r}
casnd.lm2 <- lm(log(Casualty) ~ Derail + HRX + TEMP + CARS + TRNSPD, data=casnd)
summary(casnd.lm2)
```

#Plot diagnostic graphs individually
```{r}
plot(casnd.lm2,which=1) #Residual vs. Fitted
```
This plot violates the assumptions for the residual vs fitted diagnostic plot because there is not a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm2,which=2) #QQ
```
This graph shows a violation of assumptions because the points clearly do not follow the line. This represents a failure of the Gaussian assumption for the error term. 

```{r}
plot(casnd.lm2,which=3) #Scale-Location
```
This graph shows a violation of assumptions because the points do not have a mean of zero and there is not a constant variance. 

```{r}
plot(casnd.lm2,labels.id = NULL, which=4) #Cook's distance
```

```{r}
plot(casnd.lm2,which=5) #Redisuals vs. Leverage
```
Although these graphs still show a violation of assumptions due to large Cook's distances, there is a slight improvement from the previous model after taking the log transformation. 


(b) Your treatment of ordinal and categorical variables (i.e., how were
they coded);
(c) How you assessed your models (e.g., adjusted R2, AIC, etc.);
(d) How you diagnosed problems with the models; and
(e) How you adjusted the models based on these assessments.


*Hypothesis 2* 

Fill in here steps a-e
(a) The feature and model selection techniques you used to find appropriate models for this problem;
(b) Your treatment of ordinal and categorical variables (i.e., how were
they coded);
(c) How you assessed your models (e.g., adjusted R2, AIC, etc.);
(d) How you diagnosed problems with the models; and
(e) How you adjusted the models based on these assessments.


## Part 4: Evidence and Recommendations to FRA

### Part a)

### Part b)